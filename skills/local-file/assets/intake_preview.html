<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><<ENTITY_NAME>> — Local File FY <<FISCAL_YEAR>></title>
<!-- BRAND_CSS_INJECT -->
<style>
  /* --- Template-specific styles --- */

  .copy-feedback {
    font-size: 11px;
    color: var(--sn-success);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .copy-feedback.show {
    opacity: 1;
  }

  /* --- Content area --- */
  .content {
    padding: 24px;
  }

  /* --- Header --- */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--sn-border);
  }

  .header-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--sn-text);
    letter-spacing: -0.02em;
  }

  .header-subtitle {
    font-size: 12px;
    color: var(--sn-text-muted);
    margin-top: 4px;
  }

  /* --- Sections --- */
  .section {
    background: var(--sn-surface);
    border: 1px solid var(--sn-border);
    border-radius: var(--sn-radius);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--sn-border);
    background: var(--sn-surface-hover);
  }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--sn-text-muted);
  }

  .section-content {
    padding: 16px;
  }

  /* --- Field rows (entity details — read-only) --- */
  .fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--sn-border);
  }

  .field {
    background: var(--sn-surface);
    padding: 12px 16px;
  }

  .field-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sn-text-dim);
    margin-bottom: 4px;
  }

  .field-value {
    font-size: 13px;
    color: var(--sn-text);
    font-weight: 500;
  }

  .field-value.mono {
    font-family: var(--sn-font-mono);
    font-size: 12px;
  }

  /* --- Editable textarea --- */
  textarea.edit-area {
    width: 100%;
    min-height: 80px;
    background: var(--sn-bg);
    color: var(--sn-text);
    border: 1px solid var(--sn-border);
    border-radius: 6px;
    padding: 12px;
    font-family: var(--sn-font);
    font-size: 13px;
    line-height: 1.7;
    resize: vertical;
    outline: none;
    transition: border-color 0.15s;
  }

  textarea.edit-area:focus {
    border-color: var(--sn-border-focus);
  }

  textarea.edit-area::placeholder {
    color: var(--sn-text-dim);
    font-style: italic;
  }

  /* --- Table --- */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    text-align: left;
    padding: 10px 16px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sn-text-dim);
    background: var(--sn-surface-hover);
    border-bottom: 1px solid var(--sn-border);
  }

  thead th:nth-child(3) {
    text-align: right;
  }

  tbody td {
    padding: 0;
    border-bottom: 1px solid var(--sn-border);
    color: var(--sn-text);
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  tbody tr:hover {
    background: var(--sn-surface-hover);
  }

  /* --- Table inputs --- */
  td input.cell-input {
    width: 100%;
    background: transparent;
    color: var(--sn-text);
    border: none;
    padding: 10px 16px;
    font-family: var(--sn-font);
    font-size: 13px;
    outline: none;
  }

  td input.cell-input:focus {
    background: var(--sn-bg);
  }

  td:nth-child(3) input.cell-input {
    text-align: right;
    font-family: var(--sn-font-mono);
    font-size: 12px;
    font-weight: 500;
  }

  /* --- Add row button --- */
  .add-row-btn {
    display: block;
    width: 100%;
    padding: 8px 16px;
    background: transparent;
    color: var(--sn-text-dim);
    border: none;
    border-top: 1px solid var(--sn-border);
    font-family: var(--sn-font);
    font-size: 12px;
    cursor: pointer;
    text-align: left;
    transition: color 0.15s, background 0.15s;
  }

  .add-row-btn:hover {
    color: var(--sn-primary);
    background: var(--sn-surface-hover);
  }

  .footer-text {
    font-size: 11px;
    color: var(--sn-text-dim);
  }

  .footer-brand {
    font-size: 11px;
    color: var(--sn-text-dim);
    font-weight: 500;
  }

  /* --- Category dividers --- */
  .category-divider {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--sn-text-dim);
    margin: 24px 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--sn-border);
  }
  .category-divider:first-child { margin-top: 0; }

  /* --- Layer dot in section header --- */
  .layer-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    vertical-align: middle;
  }

  .layer-label {
    font-size: 10px;
    color: var(--sn-text-dim);
    vertical-align: middle;
  }

  /* --- Notes from previous sessions --- */
  .notes-container {
    background: var(--sn-surface);
    border: 1px solid var(--sn-border);
    border-left: 3px solid var(--sn-primary);
    border-radius: var(--sn-radius);
    margin-bottom: 12px;
    padding: 16px;
  }

  .notes-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--sn-primary);
    margin: 0 0 12px 0;
  }

  .notes-block {
    margin-bottom: 10px;
  }

  .notes-block:last-child {
    margin-bottom: 0;
  }

  .notes-header {
    font-size: 11px;
    font-weight: 600;
    color: var(--sn-text-muted);
    margin-bottom: 4px;
  }

  .notes-list {
    margin: 0;
    padding: 0 0 0 16px;
    list-style: none;
  }

  .notes-list li {
    font-size: 12px;
    color: var(--sn-text-muted);
    line-height: 1.6;
    position: relative;
    padding-left: 4px;
  }

  .notes-list li::before {
    content: "•";
    position: absolute;
    left: -12px;
    color: var(--sn-text-dim);
  }
</style>
</head>
<body data-theme="dark" data-entity-id="<<ENTITY_ID>>" data-fiscal-year="<<FISCAL_YEAR>>" data-currency="<<CURRENCY>>">

<!-- Sticky top bar -->
<div class="top-bar">
  <div style="display:flex;align-items:center;gap:16px">
    <span style="font-size:12px;color:var(--sn-text-dim)">Overview</span>
    <span class="nav-sep">›</span>
    <span style="font-size:12px;font-weight:600;color:var(--sn-text)">Editor</span>
    <span class="nav-sep">›</span>
    <span style="font-size:12px;color:var(--sn-text-dim)">Report view</span>
    <span class="nav-sep">›</span>
    <span style="font-size:12px;color:var(--sn-text-dim)">Final PDF</span>
  </div>
  <div class="top-bar-actions">
    <span style="font-size:11px;color:var(--sn-text-dim);margin-right:4px">Edit any field, then send your updates</span>
    <span class="copy-feedback" id="copy-feedback">Copied — paste this in the chat</span>
    <button class="btn btn-primary" id="copy-btn" onclick="copyChanges()">Send updates</button>
    <button class="theme-toggle" id="theme-btn" onclick="toggleTheme()" title="Toggle light/dark mode">☀</button>
  </div>
</div>

<!-- Content -->
<div class="content">

<!-- Header -->
<div class="header">
  <div>
    <div class="header-title"><<ENTITY_NAME>></div>
    <div class="header-subtitle">Local File — Fiscal Year <<FISCAL_YEAR>></div>
  </div>
  <span class="badge badge-accent"><<STATUS>></span>
</div>

<!-- Entity Details (read-only — structural identifiers) -->
<div class="section">
  <div class="section-header">
    <span class="section-label">Entity Details</span>
  </div>
  <div class="fields">
    <div class="field">
      <div class="field-label">Group</div>
      <div class="field-value"><<GROUP_NAME>></div>
    </div>
    <div class="field">
      <div class="field-label">Entity</div>
      <div class="field-value"><<ENTITY_NAME>></div>
    </div>
    <div class="field">
      <div class="field-label">Country</div>
      <div class="field-value"><<COUNTRY>></div>
    </div>
    <div class="field">
      <div class="field-label">Fiscal Year</div>
      <div class="field-value mono"><<FISCAL_YEAR>></div>
    </div>
  </div>
</div>

<!-- Notes from previous sessions (only shown if notes exist) -->
<<NOTES_BLOCK>>

<!-- All blueprint sections by category (dynamic) -->
<<CONTENT_SECTIONS>>

<!-- Controlled Transactions (editable table) -->
<div class="section">
  <div class="section-header">
    <span class="section-label">Controlled Transactions</span>
    <<TRANSACTIONS_BADGE>>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Transaction</th>
          <th>Counterparty</th>
          <th>Amount (<<CURRENCY>>)</th>
          <th>Method</th>
          <th>Tested party profile</th>
        </tr>
      </thead>
      <tbody id="tx-body">
        <<TRANSACTION_ROWS>>
      </tbody>
    </table>
    <button class="add-row-btn" onclick="addTransactionRow()">+ Add transaction</button>
  </div>
</div>

<!-- Footer -->
<div class="footer">
  <span class="footer-text">Confidential — For internal use only</span>
  <span class="footer-brand">Supernomial Cowork</span>
</div>

</div><!-- /content -->

<script>
// ---------------------------------------------------------------------------
// Theme toggle
// ---------------------------------------------------------------------------
function toggleTheme() {
  var body = document.body;
  var btn = document.getElementById('theme-btn');
  var current = body.getAttribute('data-theme') || 'dark';
  var next = current === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-theme', next);
  btn.textContent = next === 'dark' ? '\u2600' : '\u263E';
}

// ---------------------------------------------------------------------------
// Store original values on page load so we can diff later
// ---------------------------------------------------------------------------
var _originals = { sections: {}, transactions: [] };

(function storeOriginals() {
  var areas = document.querySelectorAll('textarea.edit-area');
  areas.forEach(function(ta) {
    _originals.sections[ta.id] = ta.value.trim();
  });

  var rows = document.querySelectorAll('#tx-body tr');
  rows.forEach(function(row) {
    var inputs = row.querySelectorAll('input.cell-input');
    if (inputs.length >= 3) {
      _originals.transactions.push({
        name: inputs[0].value.trim(),
        counterparty: inputs[1].value.trim(),
        amount: inputs[2].value.trim().replace(/,/g, '')
      });
    }
  });
})();

// ---------------------------------------------------------------------------
// Add a new empty transaction row
// ---------------------------------------------------------------------------
function addTransactionRow() {
  var tbody = document.getElementById('tx-body');
  var row = document.createElement('tr');
  row.innerHTML =
    '<td><input class="cell-input" type="text" data-field="name" placeholder="Transaction name" value=""></td>' +
    '<td><input class="cell-input" type="text" data-field="counterparty" placeholder="Counterparty" value=""></td>' +
    '<td><input class="cell-input" type="text" data-field="amount" placeholder="0" value=""></td>' +
    '<td>—</td>' +
    '<td>—</td>';
  tbody.appendChild(row);
}

// ---------------------------------------------------------------------------
// Format a number nicely (e.g. 14400000 → "14,400,000")
// ---------------------------------------------------------------------------
function fmtNum(n) {
  if (!n && n !== 0) return '0';
  return Number(n).toLocaleString('en-US', {maximumFractionDigits: 0});
}

// ---------------------------------------------------------------------------
// Collect current values and compute diff against originals
// ---------------------------------------------------------------------------
function collectChanges() {
  var body = document.body;
  var entityId = body.dataset.entityId;
  var fiscalYear = body.dataset.fiscalYear;
  var currency = body.dataset.currency;

  var changes = [];
  var sections = {};
  var txChanged = false;

  // --- Section diffs (all textareas) ---
  var areas = document.querySelectorAll('textarea.edit-area');
  areas.forEach(function(ta) {
    var key = ta.id;
    var val = ta.value.trim();
    var orig = (_originals.sections[key] || '');
    if (val !== orig) {
      sections[key] = val;
      var label = ta.getAttribute('data-label') || key;
      if (!orig && val) {
        changes.push('Added ' + label);
      } else if (orig && !val) {
        changes.push('Cleared ' + label);
      } else {
        changes.push('Updated ' + label);
      }
    }
  });

  // --- Transaction diffs ---
  var currentTx = [];
  var rows = document.querySelectorAll('#tx-body tr');
  rows.forEach(function(row) {
    var inputs = row.querySelectorAll('input.cell-input');
    if (inputs.length >= 3) {
      var name = inputs[0].value.trim();
      var cp = inputs[1].value.trim();
      var amtStr = inputs[2].value.trim().replace(/,/g, '');
      if (name || cp || amtStr) {
        currentTx.push({
          name: name,
          counterparty: cp,
          amount: amtStr ? parseFloat(amtStr) || 0 : 0
        });
      }
    }
  });

  // Compare transaction lists
  var origTx = _originals.transactions || [];
  if (currentTx.length !== origTx.length) {
    txChanged = true;
    if (currentTx.length > origTx.length) {
      changes.push('Added ' + (currentTx.length - origTx.length) + ' transaction(s)');
    } else {
      changes.push('Removed ' + (origTx.length - currentTx.length) + ' transaction(s)');
    }
  } else {
    for (var i = 0; i < currentTx.length; i++) {
      var cur = currentTx[i];
      var orig = origTx[i];
      if (cur.name !== orig.name || cur.counterparty !== orig.counterparty ||
          String(cur.amount) !== String(orig.amount)) {
        txChanged = true;
        if (String(cur.amount) !== String(orig.amount) && cur.name) {
          changes.push(cur.name + ': amount changed to ' + currency + ' ' + fmtNum(cur.amount));
        } else if (cur.name !== orig.name) {
          changes.push('Transaction renamed: "' + orig.name + '" \u2192 "' + cur.name + '"');
        } else {
          changes.push(cur.name + ': updated');
        }
      }
    }
  }

  return {
    hasChanges: changes.length > 0,
    summary: changes,
    payload: {
      _source: 'preview_edit',
      _entity_id: entityId,
      _fiscal_year: fiscalYear,
      _currency: currency,
      _summary: changes,
      sections: Object.keys(sections).length > 0 ? sections : undefined,
      transactions: txChanged ? currentTx : undefined
    }
  };
}

// ---------------------------------------------------------------------------
// Copy changes to clipboard (only diffs)
// ---------------------------------------------------------------------------
function copyChanges() {
  var result = collectChanges();
  var btn = document.getElementById('copy-btn');
  var feedback = document.getElementById('copy-feedback');

  if (!result.hasChanges) {
    btn.textContent = 'No changes to send';
    btn.style.opacity = '0.5';
    setTimeout(function() {
      btn.textContent = 'Send updates';
      btn.style.opacity = '1';
    }, 2000);
    return;
  }

  // Clean the payload — remove undefined keys
  var payload = result.payload;
  if (!payload.sections) delete payload.sections;
  if (!payload.transactions) delete payload.transactions;

  var json = JSON.stringify(payload, null, 2);

  function onSuccess() {
    btn.textContent = 'Paste this in the chat \u2193';
    btn.className = 'btn btn-success';
    feedback.classList.add('show');
    setTimeout(function() {
      btn.textContent = 'Send updates';
      btn.className = 'btn btn-primary';
      feedback.classList.remove('show');
    }, 5000);
  }

  navigator.clipboard.writeText(json).then(onSuccess).catch(function() {
    var ta = document.createElement('textarea');
    ta.value = json;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    onSuccess();
  });
}
</script>

</body>
</html>
